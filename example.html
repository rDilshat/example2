<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Releazio Demo ‚Äî Full show_interval Control</title>

    <!-- ===== INTERCEPTOR (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–í–´–ú) ===== -->
    <script>
      (function () {
        const originalFetch = window.fetch.bind(window);

        window.fetch = async (...args) => {
          const response = await originalFetch(...args);

          const url = (args[0] || "").toString().toLowerCase();
          if (url.includes("releazio") || url.includes("/check") || url.includes("/appstore") || url.includes("/googleplay")) {
            try {
              const clone = response.clone();
              const json = await clone.json();
              window.__releazioConfig = json;
              console.log("üéØ Intercepted Releazio config:", json);
            } catch (err) {
              console.warn("‚ö†Ô∏è Failed to parse intercepted response:", err);
            }
          }

          return response;
        };
      })();
    </script>

    <!-- SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@rlzio/sdk"></script>
  </head>

  <body>
    <h1>Releazio Demo (popup + badge under show_interval)</h1>
    <div id="badge-container"></div>

    <script>
      /* ====================== HELPERS ====================== */

      function waitForReleazioConfig(timeout = 6000) {
        return new Promise((resolve) => {
          const start = Date.now();
          (function check() {
            if (window.__releazioConfig) return resolve(window.__releazioConfig);
            if (Date.now() - start >= timeout) return resolve(null);
            setTimeout(check, 100);
          })();
        });
      }

      function findKeyRecursive(obj, keyName) {
        if (!obj || typeof obj !== "object") return undefined;
        const target = keyName.toLowerCase();
        const stack = [obj];

        while (stack.length) {
          const cur = stack.pop();
          for (const key in cur) {
            try {
              if (key.toLowerCase() === target) return cur[key];
              if (typeof cur[key] === "object") stack.push(cur[key]);
            } catch {}
          }
        }

        return undefined;
      }

      function parseShowInterval(raw) {
        if (raw == null) return NaN;
        if (typeof raw === "number") return raw;

        let s = String(raw)
          .trim()
          .replace(/\u00A0/g, " ")
          .replace(/[\r\n\t]/g, "")
          .trim();

        const match = s.match(/-?\d+/);
        return match ? parseInt(match[0], 10) : NaN;
      }

      function canShowPopup(intervalMinutes) {
        const last = localStorage.getItem("popup_last_shown");
        if (!last) return true;

        const lastDate = new Date(parseInt(last, 10));
        const now = new Date();

        const diffMinutes = (now - lastDate) / 1000 / 60;
        return diffMinutes >= intervalMinutes;
      }

      function markPopupShown() {
        localStorage.setItem("popup_last_shown", Date.now().toString());
      }

      /* ====================== MAIN ====================== */

      (async () => {
        await ReleazioSDK.init({
          apiKey: "rGpOXpIUWW+60H20cuXH8a1t38zJ51T6exv1heV8yMU=",
          appVersionName: "1.0.0",
          appVersionCode: "1",
          channel: "appstore",
          language: "en",
          endpoint: "https://check.dev.releazio.com",
          enableModals: false  // <--- –í–ê–ñ–ù–û!
        });

        const config = await waitForReleazioConfig();

        if (!config) {
          console.warn("‚ö†Ô∏è Config not intercepted. Using fallback.");
          await ReleazioSDK.renderBadge("#badge-container");
          await ReleazioSDK.showUpdateModal();
          markPopupShown();
          return;
        }

        console.log("CONFIG:", config);

        const raw = findKeyRecursive(config, "show_interval");
        console.log("raw show_interval =", raw);

        const showInterval = parseShowInterval(raw);
        console.log("parsed show_interval =", showInterval);

        if (isNaN(showInterval)) {
          console.warn("‚ö†Ô∏è Invalid show_interval ‚Üí fallback show");
          await ReleazioSDK.renderBadge("#badge-container");
          await ReleazioSDK.showUpdateModal();
          markPopupShown();
          return;
        }

        if (canShowPopup(showInterval)) {
          console.log("‚úÖ Interval passed ‚Üí showing popup and badge");

          await ReleazioSDK.renderBadge("#badge-container");
          await ReleazioSDK.showUpdateModal();

          markPopupShown();
        } else {
          console.log("‚è≥ Popup suppressed ‚Üí interval not passed");
        }
      })();
    </script>
  </body>
</html>
