<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Releazio Badge Demo ‚Äî robust show_interval parsing</title>

    <script>
      (function () {
        const originalFetch = window.fetch.bind(window);

        window.fetch = async (...args) => {
          try {
            const response = await originalFetch(...args);

            const url = (args[0] || "").toString().toLowerCase();
            if (url.includes("releazio") || url.includes("/check") || url.includes("/appstore") || url.includes("/googleplay")) {
              try {
                const clone = response.clone();
                const json = await clone.json();
                window.__releazioConfig = json;
                console.log("üéØ Interceptor: Releazio response saved:", json);
              } catch (err) {
                console.warn("‚ö†Ô∏è Interceptor: can't parse response body as JSON:", err);
              }
            }

            return response;
          } catch (err) {
            throw err;
          }
        };
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@rlzio/sdk"></script>
  </head>
  <body>
    <h1>Releazio demo (robust)</h1>
    <div id="badge-container"></div>

    <script>
      // ----- –ü–æ–∏—Å–∫ –∫–ª—é—á–∞ show_interval —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ -----
      function findKeyRecursive(obj, keyName) {
        if (obj == null) return undefined;
        if (typeof obj !== 'object') return undefined;

        const lowerKey = keyName.toLowerCase();

        const stack = [obj];
        while (stack.length) {
          const cur = stack.pop();

          if (cur && typeof cur === 'object') {
            for (const k of Object.keys(cur)) {
              try {
                if (k.toLowerCase() === lowerKey) {
                  return cur[k];
                }
              } catch (e) {
                // ignore weird keys
              }
              const v = cur[k];
              if (v && typeof v === 'object') stack.push(v);
            }
          }
        }
        return undefined;
      }

      // ----- –£–º–µ—Ä–µ–Ω–Ω–æ "–∂—ë—Å—Ç–∫–∏–π" –ø–∞—Ä—Å–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è -----
      function parseShowInterval(raw) {
        console.log("parseShowInterval: raw value ->", raw, "type:", typeof raw);

        if (raw == null) return NaN;

        // –µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
        if (typeof raw === 'number' && Number.isFinite(raw)) {
          return Math.trunc(raw);
        }

        // –µ—Å–ª–∏ —ç—Ç–æ boolean ‚Äî –Ω–µ–≤–∞–ª–∏–¥
        if (typeof raw === 'boolean') return NaN;

        // –µ—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç (–≤–ª–æ–∂–µ–Ω–Ω—ã–π), –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ
        if (typeof raw === 'object') {
          // –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ–ª–µ show_interval –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ
          const nested = findKeyRecursive(raw, 'show_interval');
          if (nested !== undefined && nested !== raw) {
            return parseShowInterval(nested);
          }
          return NaN;
        }

        let s = String(raw).trim();

        s = s.replace(/\u00A0/g, ' ').replace(/[\r\n\t]+/g, '').trim();

        
        if ((s.startsWith('{') && s.endsWith('}')) || (s.startsWith('[') && s.endsWith(']'))) {
          try {
            const parsed = JSON.parse(s);
            return parseShowInterval(parsed);
          } catch (e) {
            
            console.warn("parseShowInterval: string looks like JSON but parse failed:", e);
          }
        }

       
        const intMatch = s.match(/-?\d+/);
        if (intMatch) {
          const v = parseInt(intMatch[0], 10);
          if (!isNaN(v)) return v;
        }

       
        const f = parseFloat(s.replace(',', '.'));
        if (!isNaN(f)) return Math.trunc(f);

        return NaN;
      }

      function canShowPopup(showIntervalMinutes) {
        if (!showIntervalMinutes && showIntervalMinutes !== 0) return true;
        const lastShown = localStorage.getItem('popup_last_shown');
        if (!lastShown) return true;
        const last = new Date(parseInt(lastShown, 10));
        const now = new Date();
        const diffMinutes = (now - last) / 1000 / 60;
        return diffMinutes >= showIntervalMinutes;
      }

      function markPopupShown() {
        localStorage.setItem('popup_last_shown', Date.now().toString());
      }

      function waitForReleazioConfig(timeoutMs = 6000, pollInterval = 100) {
        return new Promise((resolve) => {
          const start = Date.now();
          (function poll() {
            if (window.__releazioConfig) {
              resolve(window.__releazioConfig);
              return;
            }
            if (Date.now() - start >= timeoutMs) {
              resolve(null);
              return;
            }
            setTimeout(poll, pollInterval);
          })();
        });
      }

      (async () => {
        try {
          await ReleazioSDK.init({
            apiKey: 'rGpOXpIUWW+60H20cuXH8a1t38zJ51T6exv1heV8yMU=',
            appVersionName: '1.0.0',
            appVersionCode: '1',
            channel: 'appstore',
            language: 'en',
            endpoint: 'https://check.dev.releazio.com',
            enableModals: true
          });

          const config = await waitForReleazioConfig(6000);

          if (!config) {
            console.warn("‚ö†Ô∏è Interceptor: config not found. Falling back to direct render.");
            await ReleazioSDK.renderBadge('#badge-container');
            markPopupShown();
            return;
          }

          console.log("Interceptor CONFIG:", config);

          const raw = findKeyRecursive(config, 'show_interval');
          console.log("Interceptor: found raw show_interval via recursive search ->", raw);

          const showInterval = parseShowInterval(raw);
          console.log("Final parsed showInterval =", showInterval, "isNaN:", isNaN(showInterval));

          if (isNaN(showInterval)) {
            console.warn("‚ö†Ô∏è show_interval –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å. –ü–æ–∫–∞–∑—ã–≤–∞—é popup (fallback).");
            await ReleazioSDK.renderBadge('#badge-container');
            markPopupShown();
            return;
          }

          if (canShowPopup(showInterval)) {
            await ReleazioSDK.renderBadge('#badge-container');
            markPopupShown();
            console.log("‚úÖ Popup shown. show_interval:", showInterval);
          } else {
            console.log("‚è≥ Popup suppressed. show_interval:", showInterval);
          }
        } catch (err) {
          console.error("Unexpected error:", err);
          try {
            await ReleazioSDK.renderBadge('#badge-container');
            markPopupShown();
          } catch (e) {
            console.warn("Failed to render badge:", e);
          }
        }
      })();
    </script>
  </body>
</html>
